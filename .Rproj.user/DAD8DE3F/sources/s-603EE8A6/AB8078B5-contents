

library(REddyProc)
rm(list=ls(all=TRUE))

#i=1 #turn on for testing
ipf <- "C:/BRAVE/slu/eddy_covariance/myphd/Data_organized/Halsingfors/Eddypro_output/Halsingfors_for_ReddyProc.txt" #update the file path and file name accordingly
EddyData.F <- fLoadTXTIntoDataframe(ipf)

#+++ If not provided, calculate VPD from Tair and rH
# EddyData.F <- cbind(EddyData.F,VPD=fCalcVPDfromRHandTair(EddyData.F$rH, EddyData.F$Tair))

#+++ Add time stamp in POSIX time format
EddyDataWithPosix.F <- fConvertTimeToPosix(EddyData.F, 'YDH', Year='Year', Day='DoY', Hour='Hour')

#+++ Initalize R5 reference class sEddyProc for processing of eddy data
#+++ with all variables needed for processing later
EddyProc.C <- sEddyProc$new('EQTP', EddyDataWithPosix.F, c('NEE','Rg','Tair','VPD')) #change 'NEE' to other variable names if gapfilling other fluxes (have to match the variable name in the input data file)
EddyProc.C$sSetLocationInfo(LatDeg=64.15958801, LongDeg=19.55142097, TimeZoneHour=1)  #Location of Halsingfors

#+++ Fill gaps in variables with MDS gap filling algorithm (without prior ustar filtering)
EddyProc.C$sMDSGapFill('Tair', FillAll=FALSE)  	# Gap-filled Tair needed for partitioning and gapfilling
EddyProc.C$sMDSGapFill('VPD', FillAll=FALSE)  	# Gap-filled VPD needed for gapfilling
EddyProc.C$sMDSGapFill('Rg', FillAll=FALSE)     #Fill only the gaps for the meteo condition, e.g. 'Rg'
EddyProc.C$sMDSGapFill('NEE', FillAll=TRUE)     #Fill all values to estimate flux uncertainties

#+++ Partition NEE into GPP and respiration
EddyProc.C$sMRFluxPartition()	# night time partitioning -> Reco, GPP

#+++ Export gap filled and partitioned data to standard data frame
FilledEddyData.F <- EddyProc.C$sExportResults()

#+++ Save results into (tab-delimited) text file in directory
CombinedData.F <- cbind(EddyData.F, FilledEddyData.F)

#+++ May rename variables to correspond to Ameriflux 
colnames(CombinedDataAmeriflux.F <- renameVariablesInDataframe(CombinedData.F, getBGC05ToAmerifluxVariableNameMapping() ))
CombinedDataAmeriflux.F$TIMESTAMP_END <- POSIXctToBerkeleyJulianDate( EddyProc.C$sExportData()[[1]] )
head(tmp <- BerkeleyJulianDateToPOSIXct( CombinedDataAmeriflux.F$TIMESTAMP_END ))
colnames(tmp <- renameVariablesInDataframe(CombinedData.F, getAmerifluxToBGC05VariableNameMapping() ))
#opf <- paste0("EQTP_output_sim",toString(i),".txt") #update the output file name
fWriteDataframeToFile(CombinedData.F, "Halsingfors_ReddyProc_GF.txt", "C:/BRAVE/slu/eddy_covariance/myphd/Data_organized/Halsingfors/Eddypro_output") #update the output file path

# #+++ Example plots of filled data to screen or to directory /plots
EddyProc.C$sPlotFingerprintY('NEE_f', Year=2021) #gapfilled NEE fingerprint, update the year accordingly


